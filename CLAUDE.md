# CLAUDE.md — LMSACE Reports Plugin

## Project Overview

**Package:** `report_lmsace_reports`
**Type:** Moodle Report Plugin (installed at `report/lmsace_reports`)
**Version:** v1.1 (version code `2025060203`)
**License:** GNU GPL v3
**Supported Moodle:** 4.04 (404) through 5.0 (500)
**Supported PHP:** 7.4, 8.0, 8.2

This is a comprehensive analytics and reporting plugin for Moodle LMS. It provides configurable dashboard widgets for site-level, course-level, user-level, teacher-level, and evaluation-level reports. The plugin is **read-only** — it does not create custom database tables, only queries standard Moodle tables.

## Repository Structure

```
├── amd/                          # AMD JavaScript modules (Moodle's JS module system)
│   ├── build/                    # Compiled/minified JS (generated by Grunt)
│   └── src/                      # Source JS files
│       ├── main.js               # Main orchestrator, loaded by index.php
│       └── chartjs-plugin-datalabels.js  # Third-party Chart.js plugin (MIT)
├── classes/                      # PHP classes (PSR-4 autoloaded under report_lmsace_reports\)
│   ├── cache/loader.php          # Custom cache loader
│   ├── local/
│   │   ├── table/                # Dynamic table classes + filterset classes
│   │   └── widgets/              # Widget implementations (CANONICAL location)
│   ├── output/                   # Moodle renderable/renderer classes
│   │   ├── lmsace_reports.php    # Main renderable
│   │   ├── renderer.php          # Plugin renderer (extends plugin_renderer_base)
│   │   ├── report_widgets.php    # Widget collection renderer
│   │   └── widgets_info.php      # Base class for all widgets
│   ├── privacy/provider.php      # Privacy API (null_provider — no user data stored)
│   ├── table/                    # Legacy table classes (duplicates of local/table/)
│   ├── widgets/                  # Legacy widget classes (duplicates of local/widgets/)
│   ├── report_helper.php         # Core static helper (~893 lines of SQL queries/data processing)
│   └── widgets.php               # Widget registry and static helpers
├── db/
│   ├── access.php                # Capability definitions (7 capabilities)
│   ├── caches.php                # Cache definitions (reportwidgets)
│   └── services.php              # Web service/AJAX endpoint definitions (6 services)
├── form/
│   └── chooser_form.php          # Moodle form classes (course/user/teacher selectors)
├── lang/
│   └── en/report_lmsace_reports.php  # English language strings
├── templates/                    # Mustache templates
│   ├── widgets/                  # Widget-specific templates
│   └── widgetstable/             # Table widget templates
├── tests/
│   └── behat/
│       └── reports_management.feature  # Behat acceptance tests
├── .github/workflows/
│   └── moodle-ci.yml             # GitHub Actions CI pipeline
├── cache.php                     # Cache purge handler
├── externallib.php               # Web service implementations (~437 lines)
├── index.php                     # Main entry point / report page
├── lib.php                       # Plugin library: constants + navigation hooks
├── settings.php                  # Admin settings: enable/disable widgets
├── styles.css                    # Plugin CSS
├── thirdpartylibs.xml            # Third-party library declarations
└── version.php                   # Plugin version metadata
```

## Architecture

### Widget System

The plugin uses a widget-based architecture. Each report element is a self-contained widget:

1. **Stack widgets** aggregate child widgets for a report category (e.g., `stacksitereportswidget` contains all site-level widgets)
2. **Individual widgets** handle data fetching and template rendering
3. All widgets extend `classes/output/widgets_info.php`
4. Widgets are registered via constants in `lib.php` and toggled in `settings.php`

Widget classes live in `classes/local/widgets/`. There is a parallel set under `classes/widgets/` (legacy). The `local/` versions are the canonical ones.

### Data Flow

```
Browser → AMD JS (amd/src/main.js)
       → AJAX calls to web services (externallib.php)
       → Widget classes fetch data via report_helper.php
       → SQL queries against standard Moodle tables
       → Mustache templates render output
       → Response returned to browser
```

### Report Types

| Report Type | Capability Required | Context Level | Widget Count |
|---|---|---|---|
| Site | `viewsitereports` | System | 10 |
| Course | `viewcoursereports` | Course | 6 |
| User | `viewuserreports` | User | 8 |
| Teacher | `viewteacherreports` | System | 5 |
| Evaluation | `viewevaluationreports` | System | 4 |

### Key Classes

- **`report_helper`** (`classes/report_helper.php`): Central data access layer. Contains all SQL queries and data processing as static methods.
- **`widgets`** (`classes/widgets.php`): Widget registry. Maps widget identifiers to class names.
- **`renderer`** (`classes/output/renderer.php`): Moodle renderer. Orchestrates which widgets to display based on report type and admin settings.
- **`report_lmsace_reports_external`** (`externallib.php`): All 6 AJAX web service methods.

### Web Services (AJAX Endpoints)

Defined in `db/services.php`, implemented in `externallib.php`:

| Service | Method | Purpose |
|---|---|---|
| `report_lmsace_reports_get_chart_reports` | `get_chart_reports` | Fetch chart data |
| `report_lmsace_reports_activity_progress_reports` | `get_activity_progress_reports` | Activity progress |
| `report_lmsace_reports_table_reports` | `get_table_reports` | Table/info data |
| `report_lmsace_reports_enrollment_completion_month` | `get_enrollment_completion_bymonths` | Monthly stats |
| `report_lmsace_reports_site_visits` | `get_site_visits` | Visit logs |
| `report_lmsace_reports_get_moodle_used_size` | `get_moodle_used_size` | Disk usage |

### Capabilities

Defined in `db/access.php`:

- `report/lmsace_reports:definestudents` — Student role (course context)
- `report/lmsace_reports:viewsitereports` — Manager role (system context)
- `report/lmsace_reports:viewcoursereports` — Teacher/editing teacher (course context)
- `report/lmsace_reports:viewuserreports` — User role (user context)
- `report/lmsace_reports:viewotheruserreports` — Manager role (user context)
- `report/lmsace_reports:viewteacherreports` — Manager role (system context)
- `report/lmsace_reports:viewevaluationreports` — Manager role (system context)

## Development Workflow

### CI Pipeline

The GitHub Actions workflow (`.github/workflows/moodle-ci.yml`) runs on push and pull requests with this test matrix:

| PHP | Moodle Branch | Database |
|---|---|---|
| 8.2 | MOODLE_403_STABLE | PostgreSQL 13 |
| 8.0 | MOODLE_402_STABLE | MariaDB 10 |
| 8.0 | MOODLE_401_STABLE | PostgreSQL 13 |
| 7.4 | MOODLE_400_STABLE | MariaDB 10 |

### CI Checks (in order)

1. **PHP Lint** — `moodle-plugin-ci phplint`
2. **PHP Mess Detector** — `moodle-plugin-ci phpmd` (continue-on-error)
3. **Moodle Code Checker (PHPCS)** — `moodle-plugin-ci phpcs --max-warnings 0`
4. **Moodle PHPDoc Checker** — `moodle-plugin-ci phpdoc --max-warnings 0`
5. **Validation** — `moodle-plugin-ci validate`
6. **Upgrade Savepoints** — `moodle-plugin-ci savepoints`
7. **Mustache Lint** — `moodle-plugin-ci mustache`
8. **Grunt** — `moodle-plugin-ci grunt` (JS compilation)
9. **PHPUnit** — `moodle-plugin-ci phpunit --fail-on-warning`
10. **Behat** — `moodle-plugin-ci behat --profile chrome`

### JavaScript Build

JavaScript source files live in `amd/src/`. Moodle requires compiled/minified versions in `amd/build/`.

- Build tool: **Grunt** (Moodle's standard JS build)
- The file `chartjs-plugin-datalabels.js` is excluded from linting via `IGNORE_NAMES` in CI config
- After modifying any JS in `amd/src/`, you must rebuild with Grunt before committing

### Testing

- **Behat tests** in `tests/behat/reports_management.feature`
- Tests cover enable/disable workflows for site, course, and user report widgets
- Tests use Moodle's Behat step definitions with `@javascript` tag (requires browser driver)
- No PHPUnit test files currently exist in the repository

## Coding Conventions

### PHP

- **Namespace:** `report_lmsace_reports` (all classes under `classes/`)
- **File header:** Every PHP file must include the GPL v3 license header and `@package report_lmsace_reports`
- **Security guard:** Every PHP file starts with `defined('MOODLE_INTERNAL') || die;` (or `die()`)
- **Moodle coding style:** Follows Moodle's PHPCS ruleset (enforced by CI). Key rules:
  - 4-space indentation
  - `snake_case` for functions and variables
  - Full PHPDoc on all classes and public methods
  - No inline closing PHP tags
- **Parameter handling:** Use `optional_param()` / `required_param()` with `PARAM_*` type constants
- **Capability checks:** Always verify capabilities before showing data or executing operations
- **SQL:** Use Moodle's `$DB` API with parameterized queries. Never concatenate user input into SQL.
- **Language strings:** All user-facing text goes in `lang/en/report_lmsace_reports.php` and is accessed via `get_string()`

### JavaScript

- AMD module format (RequireJS-compatible)
- Source in `amd/src/`, compiled output in `amd/build/`
- Main entry point: `amd/src/main.js` (loaded via `$PAGE->requires->js_call_amd()`)
- Uses Chart.js for data visualization

### Templates

- Mustache templates in `templates/`
- Follow Moodle's Mustache conventions
- No logic in templates — all data prepared in PHP renderables

### CSS

- Single `styles.css` file at the root
- Moodle automatically loads it for the plugin
- Use `.lmsace-reports-body` body class for scoped styles

## Key Patterns for AI Assistants

### Adding a New Widget

1. Create the widget class in `classes/local/widgets/` extending `widgets_info`
2. Add a constant in `lib.php` for the widget identifier
3. Register the widget in the appropriate stack widget class
4. Add the enable/disable checkbox in `settings.php`
5. Add language strings in `lang/en/report_lmsace_reports.php`
6. Create a Mustache template in `templates/` if needed
7. Add any AJAX data methods to `externallib.php` and register in `db/services.php`
8. Bump the version in `version.php`

### Adding a New Table

1. Create the table class in `classes/local/table/` extending Moodle's `dynamic_table`
2. Create a matching `*_filterset` class for dynamic filtering
3. Wire it into the relevant widget or external service

### Common Pitfalls

- **Dual class locations:** Widget and table classes exist in both `classes/local/` and `classes/` (without `local`). The `classes/local/` versions are canonical. The root `classes/widgets/` and `classes/table/` directories contain legacy copies.
- **Version bump:** Any change to `db/` files (access, services, caches) requires incrementing `$plugin->version` in `version.php`
- **JS rebuild required:** After editing `amd/src/*.js`, the minified `amd/build/` versions must be regenerated
- **No custom DB tables:** This plugin never creates its own tables. All data comes from standard Moodle tables.
- **Admin user exclusion:** User reports explicitly skip admin users (`is_siteadmin()` check in `index.php`)
- **Cache invalidation:** Widget definitions are cached at the application level. Use `cache.php` to purge.

### Navigation Entry Points

- **Site admin:** `Site Administration > Reports > LMSACE Reports`
- **Course reports:** Added via `report_lmsace_reports_extend_navigation_course()` in `lib.php`
- **User profile:** Added via `report_lmsace_reports_myprofile_navigation()` in `lib.php`
- **Main URL:** `/report/lmsace_reports/index.php?report={sitereport|coursereport|userreport|teacherreport|evaluationreport}`

### Third-Party Dependencies

- **Chart.js datalabels plugin** v2.2.0 (MIT) — declared in `thirdpartylibs.xml`, located at `amd/src/chartjs-plugin-datalabels.js`
- No Composer dependencies
- No npm `package.json` (uses Moodle's Grunt setup)
